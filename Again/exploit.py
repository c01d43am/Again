import os
import subprocess

def check_and_install_sqlmap():
    """Checks if sqlmap is installed. Installs it if not found."""
    try:
        result = subprocess.run("which sqlmap", shell=True, capture_output=True)
        if result.returncode == 0:
            print("sqlmap is already installed.")
            return True
        else:
            print("sqlmap is not installed. Installing now...")
            os.system("git clone https://github.com/sqlmapproject/sqlmap.git ~/sqlmap")
            print("sqlmap has been installed successfully.")
            return True
    except Exception as e:
        print(f"Failed to install sqlmap: {e}")
        return False


def run_sqlmap(target_url):
    """Run sqlmap to check for SQL injection vulnerabilities on the target URL."""
    python_cmd = "python3" if os.system("which python3") == 0 else "python"  # Check if python3 exists, fallback to python
    print(f"\nRunning sqlmap on {target_url} using {python_cmd}...")
    try:
        command = f"{python_cmd} ~/sqlmap/sqlmap.py -u {target_url} --batch --risk=3 --level=5"
        subprocess.run(command, shell=True, check=True)
        print(f"sqlmap scan completed for {target_url}.")
    except subprocess.CalledProcessError as e:
        print(f"Failed to run sqlmap on {target_url}: {e}")
    except Exception as e:
        print(f"An unexpected error occurred while running sqlmap: {e}")


def mysql_injection_tool():
    """Tool to check for SQL injection vulnerabilities using sqlmap."""
    while True:
        print("\nMySQL Injection Tool:")
        print("1. Run sqlmap on a Target URL")
        print("2. Return to Main Menu\n")

        choice = input("Enter your choice [1-2]: ")
        if choice == "1":
            target_url = input("Enter the target URL (including http/https): ")
            if target_url:
                if check_and_install_sqlmap():  # Check and install sqlmap if not installed
                    run_sqlmap(target_url)  # Run sqlmap for the given URL
            else:
                print("Invalid URL. Please try again.")
        elif choice == "2":
            print("Returning to Main Menu.")
            break
        else:
            print("Invalid choice, please try again.")
        print()


if __name__ == "__main__":
    mysql_injection_tool()
