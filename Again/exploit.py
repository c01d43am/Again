import os
import subprocess

def check_and_install_sqlmap():
    """Checks if sqlmap is installed. Installs it if not found."""
    try:
        result = subprocess.run("which sqlmap", shell=True, capture_output=True)
        if result.returncode == 0:
            print("sqlmap is already installed.")
            return True
        else:
            print("sqlmap is not installed. Installing now...")
            os.system("git clone https://github.com/sqlmapproject/sqlmap.git ~/sqlmap")
            print("sqlmap has been installed successfully.")
            return True
    except Exception as e:
        print(f"Failed to install sqlmap: {e}")
        return False


def check_and_install_xsstrike():
    """Checks if XSStrike is installed. Installs it if not found."""
    try:
        result = subprocess.run("which xsstrike", shell=True, capture_output=True)
        if result.returncode == 0:
            print("XSStrike is already installed.")
            return True
        else:
            print("XSStrike is not installed. Installing now...")
            os.system("git clone https://github.com/s0md3v/XSStrike.git ~/XSStrike")
            print("XSStrike has been installed successfully.")
            return True
    except Exception as e:
        print(f"Failed to install XSStrike: {e}")
        return False


def run_sqlmap(target_url):
    """Run sqlmap to check for SQL injection vulnerabilities on the target URL."""
    python_cmd = "python3" if os.system("which python3") == 0 else "python"  # Check if python3 exists, fallback to python
    print(f"\nRunning sqlmap on {target_url} using {python_cmd}...")
    try:
        command = f"{python_cmd} ~/sqlmap/sqlmap.py -u {target_url} --batch --risk=3 --level=5"
        subprocess.run(command, shell=True, check=True)
        print(f"sqlmap scan completed for {target_url}.")
    except subprocess.CalledProcessError as e:
        print(f"Failed to run sqlmap on {target_url}: {e}")
    except Exception as e:
        print(f"An unexpected error occurred while running sqlmap: {e}")


def run_xsstrike(target_url):
    """Run XSStrike to check for XSS vulnerabilities on the target URL."""
    print(f"\nRunning XSStrike on {target_url}...")
    try:
        command = f"python3 ~/XSStrike/xsstrike.py -u {target_url} --crawl 2 --threads 10"
        subprocess.run(command, shell=True, check=True)
        print(f"XSStrike scan completed for {target_url}.")
    except subprocess.CalledProcessError as e:
        print(f"Failed to run XSStrike on {target_url}: {e}")
    except Exception as e:
        print(f"An unexpected error occurred while running XSStrike: {e}")


def exploit_tool_menu():
    """Tool menu to check for SQL injection or XSS vulnerabilities using sqlmap or XSStrike."""
    while True:
        print("\nVulnerability Testing Tool:")
        print("1. Run SQL Injection test with sqlmap")
        print("2. Run XSS test with XSStrike")
        print("3. Return to Main Menu\n")

        choice = input("Enter your choice [1-3]: ")
        if choice == "1":
            target_url = input("Enter the target URL (including http/https): ")
            if target_url:
                if check_and_install_sqlmap():  # Check and install sqlmap if not installed
                    run_sqlmap(target_url)  # Run sqlmap for the given URL
            else:
                print("Invalid URL. Please try again.")
        elif choice == "2":
            target_url = input("Enter the target URL (including http/https): ")
            if target_url:
                if check_and_install_xsstrike():  # Check and install XSStrike if not installed
                    run_xsstrike(target_url)  # Run XSStrike for the given URL
            else:
                print("Invalid URL. Please try again.")
        elif choice == "3":
            print("Returning to Main Menu.")
            break
        else:
            print("Invalid choice, please try again.")
        print()


if __name__ == "__main__":
    exploit_tool_menu()
